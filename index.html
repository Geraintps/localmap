<!DOCTYPE HTML>
<html>
<!--
TO DO
* Test on multiple browsers - Safari ...
* Sign-in and place ownership
* Videos and other file types
* Extend map area
* Zoom out
* Dynamic update - polling
* Welsh option
* Push to online map
* Prettier, animated display of points
* In popped view, place texts, and pics on screen, set bkgnd colour/img
* Tag media; invent new tags
* Adjust place position, delete place
* Expand text
* Automatic positioning of photos that have loc metadata
* Drone view - sync w drone movement
-->

<head>
    <script src="scripts/filedb.js"></script>
    <script>
        var knownTags = ["Anifeiliaid", "Planhigion", "Cerrig", "Pobl", "Tywydd"]; // ["Animals", "Plants", "Rocks", "People", "Weather"];
        function g(id) { return document.getElementById(id); }
        function d2(n) { return n.toFixed(2); }
        function d6(n) { return n.toFixed(6); }

        var zoom = 0;
        var isMoving = false;
        var movingFromX = 0;
        var movingFromY = 0;
        var mapOffsetX = 0;
        var mapOffsetY = 0;
        var newMapOffsetX = 0;
        var newMapOffsetY = 0;
        var mapHeight = 800;
        var mapWidth = 1978;

        var Places = {};
        var RecentUploads = {};
        var mapimgsrc = "";

        // An image or other media file attached to a place
        class Picture {
            constructor(id, place) {
                this.id = id;
                this.url = "media/" + id;
                this.caption = "What's in this picture?";
            }
            imgSrc() {
                return RecentUploads[this.id] ?  RecentUploads[this.id] : this.url;
            }
            setImgData(data) {
                RecentUploads[this.id] = data;
            }
        }

        function init() {
            makeTags();
            var mapImage = new Image();
            mapImage.onload = function (event) {
                mapHeight = mapImage.height;
                mapWidth = mapImage.width;
                var psvg = g("points");
                psvg.style.height = "" + mapHeight + "px";
                psvg.style.width = "" + mapWidth + "px";
                var mapdiv = g("mapdiv");
                mapdiv.style.height = "" + mapHeight + "px";
                mapdiv.style.width = "" + mapWidth + "px";
                centreMap(Math.floor(2400 - window.innerWidth / 2), Math.floor(800 - innerHeight / 2));
                loadPlaces();
                g("splash").style.display="none";
            }
            mapImage.src = "img/a-1.png";
            var m = g("mapdiv");
            m.style.backgroundImage = mapimgsrc = "url(img/a-1.png)";


            m.onmousedown = function (e) {
                movingFromX = e.offsetX;
                movingFromY = e.offsetY;
                isMoving = true;
            }

            m.onmouseup = exit;
            m.onmouseleave = exit;
            m.onmousemove = function (event) {
                if (isMoving && zoom == 0) {
                    var dx = event.offsetX - movingFromX;
                    var dy = event.offsetY - movingFromY;
                    newMapOffsetX = Math.max(window.innerWidth - mapWidth, Math.min(0, mapOffsetX + dx));
                    newMapOffsetY = Math.max(window.innerHeight - mapHeight, Math.min(0, mapOffsetY + dy));
                    setMapOffset(newMapOffsetX, newMapOffsetY);
                }
                reportPosition(event);
            }

            m.onauxclick = function (event) {
                event.preventDefault();
            }

            m.oncontextmenu = function (e) {
                e.preventDefault();
                closePopup();
                var x = event.offsetX - mapOffsetX;
                var y = event.offsetY - mapOffsetY;
                var placePoint = makePlacePoint(x, y, makePlace(x, y));
            }

            m.onclick = function (event) {
                closePopup();
            }

        }

        function toggleMap() {
            if (mapimgsrc.indexOf("a-1") < 0) {
                // switch to aerial
                g("mapdiv").style.backgroundImage = mapimgsrc = "url(img/a-1.png)";
                g("mapbutton").src = "img/map-icon.png";
            }
            else {
                // switch to OS
                g("mapdiv").style.backgroundImage = mapimgsrc = "url(img/b-os-1.png)";
                g("mapbutton").src = "img/aerial-icon.png";

            }

        }

        function exit(e) {
            if (isMoving) {
                isMoving = false;
                mapOffsetX = newMapOffsetX;
                mapOffsetY = newMapOffsetY;
            }
        }

        function setMapOffset(x, y) {
            g("mapdiv").style.backgroundPosition = "" + x + "px " + y + "px";
            // shift points
            var pp = g("points");
            pp.setAttribute("x", x);
            pp.setAttribute("y", y);
        }

        function centreMap(x, y) {
            mapOffsetX = -x; newMapOffsetX = -x;
            mapOffsetY = -y; newMapOffsetY = -y;
            setMapOffset(mapOffsetX, mapOffsetY);
        }


        function makePlace(x, y) {
            var place = { id: new Date().toISOString().replace(/:/g, '').replace('.', ''), x: x, y: y, text: "What's here?", pics: [] };
            Places[place.id] = place;
            return place;
        }

        // Initial load of all saved places into the map
        function loadPlaces() {
            getPlaces(function (placeArray) {
                Places = {};
                placeArray.forEach(function (place) {
                    place.pics.forEach(function (pic) {pic.__proto__ = Picture.prototype;})
                    Places[place.id] = place;
                    // Show on map:
                    var xy = place.loc ? toXY(place.loc) : { x: place.x, y: place.y };
                    makePlacePoint(xy.x, xy.y, place);
                });
            });
        }

        window.onclose = function () {
            closePopup();
        }

        function showPopup(placePoint, x, y) {
            closePopup();
            var tt = g("popuptext");
            if (placePoint != null) {
                tt.innerHTML = placePoint.place.text;
            }
            else {
                tt.innerHTML = "Describe this place";
            }
            var pop = g("popup");
            pop.style.display = "block";
            pop.style.top = "" + Math.min(y, window.innerHeight - pop.clientHeight) + "px";
            pop.style.left = "" + Math.min(x, window.innerWidth - pop.clientWidth) + "px";
            pop.placePoint = placePoint;
            var thumbnails = g("thumbnails");
            placePoint.place.pics.forEach(function (pic, ix) {
                    let img = document.createElement("img");
                    img.height = 40;
                    img.src =  pic.imgSrc();
                    thumbnails.appendChild(img);
                    img.onclick = function (event) {
                        showPic(pic);
                    }
                }
            );
            showTags(placePoint.place);
        }

        function showPic(pic) {
            g("lightbox").currentPic = pic;
            g("caption").innerHTML = pic.caption;
            g("bigpic").src = pic.imgSrc();
            g("lightbox").style.display = "block";
            g("caption").style.width = "" + Math.max(200, g("bigpic").clientWidth) + "px";

        }

        function hidePic() {
            g("lightbox").style.display='none';
            g("lightbox").currentPic.caption = g("caption").innerHTML;
        }

        /// Save place to server. Text, links to pics, etc.
        function closePopup() {
            g("thumbnails").innerHTML = "";
            var pop = g("popup");
            if (pop.style.display != "none") {
                pop.style.display = "none";
                if (pop.placePoint != null && pop.placePoint.place != null) {
                    let place = pop.placePoint.place;
                    place.text = g("popuptext").innerHTML;
                    place.loc = toLatlong(place.y, place.x);
                    sendPlace(place);

                    // Popup is reusable - only used by one place at a time
                    pop.placePoint = null;
                }

            }
        }

        function makePlacePoint(x, y, place) {
            var c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttributeNS(null, "cx", x);
            c.setAttributeNS(null, "cy", y);
            c.setAttributeNS(null, "r", 10);
            c.setAttributeNS(null, "fill", "red");
            g("points").appendChild(c);
            c.onmouseover = function (event) {
                this.style['stroke'] = "yellow";
            }
            c.onmouseout = function (event) {
                this.style['stroke'] = "none";
            }
            c.place = place;
            c.onclick = function (e) {
                showPopup(this, e.pageX, e.pageY);
                e.cancelBubble = true;
            }
            c.onauxclick = function (e) {
                e.preventDefault();
                cancelBubble = true;
            }
            c.oncontextmenu = function (e) {
                cancelBubble = true;
                e.preventDefault();
                // TODO: menu to move or delete
            }
            return c;
        }

        function reportPosition(event) {
            var m = g("mapdiv");
            var sx = (event.offsetX - mapOffsetX);
            var sy = (event.offsetY - mapOffsetY);
            var latlong = toLatlong(sy, sx);

            g("msg").innerHTML = "" + m.clientWidth + ", " + m.clientHeight + "; " +
                event.offsetX + ", " + event.offsetY + "; " +
                d2(sx) + ", " + d2(sy) + "; " +
                d6(latlong.n) + ", " + d6(latlong.e);
        }

        var Zx = 2307;
        var Zy = 1465;
        var NLx = -5.06853;
        var Mxx = 5.3323e-6;
        var Myx = 1.9495e-07;
        var NLy = 52.006453;
        var Myy = -3.307e-6;
        var Mxy = 2e-9;

        // Myx*Mxy == 3.899e-16
        // 1/(Myx*Mxy - Myy*Mxx) == 1.763431e-11
        var Mex = 187532.2;  // 1 / (Mxx - Myx*Mxy/Myy)
        var Mnx = 11055.156;  // Myx/(Myx*Mxy - Myy*Mxx)
        var Mny = -302382.2;  // 1 / (Myy - Myx*Mxy/Mxx)
        var Mey = 113.4153;  // Mxy/(Myx*Mxy - Myy*Mxx)


        function toLatlong(y, x) {
            return { e: (x - Zx) * Mxx + NLx + (y - Zy) * Myx, n: (y - Zy) * Myy + NLy + (x - Zx) * Mxy };
        }

        function toXY(latlong) {
            var re = latlong.e - NLx;
            var rn = latlong.n - NLy;
            // re == rx*Mxx + ry*Myx
            // rx == (re - ry*Myx)/Mxx
            // rn == ry*Myy + rx*Mxy
            // ry == (rn - rx*Mxy)/Myy
            // rx == (re - ((rn - rx*Mxy)/Myy)*Myx)/Mxx
            // rx == re/Mxx - (rn*Myx/Myy*Mxx) + (rx*Myx*Mxy/Myy*Mxx)
            // rx == (re/Mxx - rn*Myx/Myy*Mxx)/(1 - Myx*Mxy/Myy*Mxx)
            // rx == re/(Mxx - Myx*Mxy/Myy) + rn*Myx/(Myx*Mxy - Myy*Mxx)
            var rx = re * Mex + rn * Mnx;
            var ry = re * Mey + rn * Mny;
            return { x: rx + Zx, y: ry + Zy };
        }

        // User clicked the Add button
        function add() {
            // Make the file selection button clickable and click it:
            var uploadButton = g("uploadButton");
            uploadButton.style.display = "inline";
            uploadButton.click();
        }

        // User has selected files to upload
        function doUploadFiles(files, place) {
            g("uploadButton").style.display = "none";

            for (var i = 0; i < files.length; i++) {
                let localName = files[i].name;
                let extension = localName.match(/\.[^.]+$/);
                let picId = place.id + "-" + (Date.now() % 1000).toString() + extension;
                let pic = new Picture (picId, place);
                place.pics.push(pic);

                // Send to server:
                sendPic(pic, files[i]); 

                // Read data directly so that we can display now:
                let reader = new FileReader();
                reader.pic = pic;
                reader.onload = function () {
                    reader.pic.setImgData(reader.result);
                    let img = document.createElement("img");
                    img.height = 40;
                    img.src = reader.pic.imgSrc() ;
                    g("thumbnails").appendChild(img);
                    img.onclick = function (event) {
                        showPic(reader.pic);
                    }
                };
                reader.readAsDataURL(files[i]);

            }
        }

        function makeTags() {
            var s = "<table><tr>";
            knownTags.forEach (function (tag) {
                s+= "<td><span class='tag' id=(\"" + tag + "\") onclick='clickTag(this)'> " + tag + " </span></td>";
            });;
            s += "</tr></table>";
            g("tags").innerHTML = s;
        }

        function clickTag(span) {
            var tagClicked = span.id;
            var place = g("popup").placePoint.place;
            if (!place.tags) place.tags = [];
            var ix = place.tags.indexOf(tagClicked);
            if (ix < 0) place.tags.push(tagClicked);
            else place.tags.splice(ix, 1);
            showTags(place);
        }

        function showTags(place) {
            var tagSpans = document.getElementsByClassName("tag");
            for (var i = 0; i<tagSpans.length; i++) {
                var tagSpan = tagSpans[i];
                if (place.tags && place.tags.indexOf(tagSpan.id) >= 0) {
                    tagSpan.style.borderColor = "coral";
                    tagSpan.style.borderStyle = "solid";
                }
                else {
                    tagSpan.style.borderStyle = "none";
                }
            }
        }


    </script>
    <style>
        #popup {
            display: none;
            position: absolute;
            width: 350px;
            height: 300px;
            background-color: rgb(231, 243, 243);
            border-radius: 4px;
        }

        #popuptext {
            position: absolute;
            top: 25px;
            left: 0px;
            right: 0px;
            bottom: 40px;
            font-size: 18px;
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color:rgb(88, 45, 13);
            margin: 4px;
            overflow: auto;
        }

        .picturebar {
            position: absolute;
            bottom: 0px;
            left: 0px;
            right: 0px;
            height: 20px;
            background-color: rgb(253, 248, 220);
        }

        .lightbox {
            display: none;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #tags {
            background-color: cornflowerblue;
        }
        .tag {
            background-color: #f0c9f9;
            font-family: Arial, Helvetica, sans-serif;
            padding: 4px;
            border-radius: 4px;
        }
        .tag:hover {
            background-color: #a069a9;
        }

    </style>
</head>

<body onload="init()">
    <svg id="mapdiv" style="background-color: blue; position: fixed; top:20px; left:0px;width:100%;height:100%">
        <svg id="points"></svg>
    </svg>
    <img style="position:fixed; top:10px; right:10px;" id="mapbutton" onclick="toggleMap()" src="img/map-icon.png" />
    <div id="popup">
        
        <div id="tags" style="height:20px;width:100%;"> </div>
        <div id="popuptext" contenteditable="true">
        </div>
        <!-- Here be pictures -->
        <!-- TO DO: display the thumbnails in a nice circle around the point -->
        <div class="picturebar">
            <div id="thumbnails"></div>
            <!-- The add button displays the ugly traditional "input file" and clicks it -->
            <button onclick="add()" style="display:inline">Add</button>
            <!-- But we set opacity:0 so the ugly input isn't visible, even when 'displayed' -->
            <input id="uploadButton" style="display:none;opacity: 0;"
                onchange="doUploadFiles(this.files, g('popup').placePoint.place)" type="file" title="upload"
                name="Upload" multiple />
        </div>
    </div>
    <div id="lightbox" class="lightbox" onclick="hidePic()"
        style ="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;">
        <div style="position: absolute; top: 10%; left: 10%; bottom:10%; right:10%;">
            <img style="max-height:90%;max-width:100%;position:relative;top:0px;vertical-align: middle;" id="bigpic" />
            <div id="caption" style="position:relative; display:block; min-width:100px;background-color: black;color:white; padding:6px;"
            contenteditable onclick="event.cancelBubble=true" >Caption
            </div>
        </div>
    </div>
    <div style="position:fixed; top:0px; left: 0px;padding:4px;" id="msg"></div>
    <div id="splash"><h1 style="background-color: salmon;position:absolute;top:40vh;left:40vw;">Loading ...</h1></div>
</body>

</html>