<html>

<head>
    <title>Signed in</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1" />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <link rel="icon" type="image/png" href="img/favicon96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="img/favicon32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="img/favicon16.png" sizes="16x16" />
    <style>
        body {
            background: aliceblue;
            font-family: 'Segoe UI', Helvetica, Arial, Sans-Serif;
        }
    </style>
    <script src="scripts/util.js?v=1.1"></script>
    <script>

        /** Return from Azure 3rd-party sign-in. 
         * Check we have email and other user info.
         */
        function init() {
            // checkUser looks up the user in our list.
            // If not there, it adds what it can deduce from the x-ms- headers.
            // This might include full name or email, depending on the 3rd party.
            // We might have to look up the full name separately or ask for the email.
            fetch("https://deep-map.azurewebsites.net/api/CheckUser")
                .then(r => r.json())
                .then(r => {
                    if (r.entries.length == 0) {
                        g("nologin").style.visibility = "visible";
                    }
                    else if (!r.entries[0].email || !r.entries[0].email._) {
                        g("noemail").style.visibility = "visible";
                    } else if (!r.entries[0].FullName || !r.entries[0].FullName._) {
                        getFullName();
                    } else {
                        done();
                    }
                });
        }

        /** Get additional user info from the Azure 3rd-pary sign-in system.
         */
        function getFullName() {
            fetch("/.auth/me")
                .then(r = r.json())
                .then(r => {
                    if (r.length > 0 && r[0].user_claims) {
                        for (let i = 0; i < r[0].user_claims.length; i++) {
                            let c = r[0].user_claims[i];
                            if (c.typ == "name" || c.typ.indexOf(":name") >= 0) {
                                if (c.val.indexOf("@") < 0) {
                                    setUserName(c.val);
                                    break;
                                }
                            }
                        }
                    }
                });
        }

        /** Add the name of the currently signed-in user to our user table.
         */
        function setUserName(name) {
            fetch("https://deep-map.azurewebsites.net/api/CheckUser?name="+name)
            .then (r => {
                done();
            });
        }

        function verifyEmail() {
            let email = g("emailEntry").value.trim();
            if (!email || email.length < 10 || email.indexOf("@") < 0) return;
            g("verifyButton").disabled = true;
            g("emailEntry").contentEditable = false;
            fetch("https://deep-map.azurewebsites.net/api/verifyEmail?email=" + email)
                .then(r => {
                    done(); // Automated email verification unreliable, so...
                    // g("emailSent").style.visibility="visible";
                });

        }
        function checkToken(token) {
            let email = g("emailEntry").value.trim();
            fetch("https://deep-map.azurewebsites.net/api/verifyEmail?token=" + token + "&email=" + email)
                .then(r => {
                    done();
                });
        }
        function done() {
            try {
                window.opener.signinDone();
            } catch (exx) { }
            window.close();
        }
    </script>
</head>

<body onload="init()">
    <div id="nologin" style="visibility: collapse;">
        Not logged in.
        <button onclick="done()">OK</button>
    </div>
    <div id="noemail" style="visibility: collapse;">
        <h1>One more thing...</h1>
        <p>We don't have your email address. Could you please provide it:</p>
        <input id="emailEntry" type="email" />
        <p>Thanks!</p>
        <button id="verifyButton" onclick="verifyEmail()">Submit</button>
        <div id="emailSent" style="visibility: collapse;">
            <p>Sent an email containing a code ... please enter the code here: <input id="tokenInput" type="number"
                    onchange="checkToken(this.value.trim())" /></p>
            <p>Can't find it? Look in your Spam or Junk folder.</p>
        </div>
    </div>
</body>

</html>