<!DOCTYPE HTML>
<html>

<head>
    <title>Map Digi Penfro</title>
    <meta name="viewport"
        content="width=device-width, user-scalable=no, minimum-scale=1, maximum-scale=1,initial-scale=1" />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <script>window.version = 1.4;</script>
    <script src="scripts/azure-storage.common.min.js"></script>
    <script src="scripts/azure-storage.blob.min.js"></script>
    <script src="scripts/jquery-3.4.1.min.js"></script>
    <script src="scripts/markerclustererplus.min.js"></script>
    <script src="scripts/util.js?v=1.8"></script>
    <script src="scripts/sign-in.js?v=1.9"></script>
    <script src="scripts/exif-js.js"></script>
    <script src="scripts/model.js?v=1.19"></script>
    <script src="scripts/azuredb.js?v=1.22"></script>
    <style> .me {background-color: lightgray;} </style>
    <script>
        function x(u, p){return u && u[p] ? u[p]._ : "";}
        function init() {
            getFile("https://deep-map.azurewebsites.net/api/userRoles", response => {
                g("project").innerHTML = response.project;
                let roles = {viewer:1};
                let projects = {};
                response.users.forEach(u => { 
                    x(u,"Role").split(";").forEach(u=>{
                        let bits=u.split(":");
                        if (bits.length==2) {
                            roles[bits[0]] = 1;
                            projects[bits[1]] = 1;
                        }
                    });
                });
                let projectsToTabulate = response.project ? [response.project] : Object.keys(projects);
                g("usertable").innerHTML=
                    response.users.map(u => {
                        let roles = x(u,"Role").split(";");
                        let isMeClass = x(u,"RowKey") == myId ? "class='me'" : "";
                        return `<tr id="${x(u,"RowKey")}" ${isMeClass}><td>${x(u,"FullName")}</td><td>${x(u,"DisplayName")}</td><td>${x(u,"email")}</td>` 
                        + projectsToTabulate.map(p=> `<td>${(roles.find(r=>r.indexOf(":"+p)>=0) || "").split(":")[0]}</td>`).join("")  
                        + "</tr>"
                    }).join("");
            });
        }
    </script>
</head>

<body onload="init()">
    <h3 id="project"></h3>
    <table id="usertable">
    </table>
</body>
</html>